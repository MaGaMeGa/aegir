#!/usr/bin/env python3.6

import json
import zmq
import time
import sys
from pprint import pprint

program = {'boiltime': 60,
           'endtemp': 80,
           'hops': [{'attime': 60, 'hopname': 'Hop 1', 'hopqty': 10, 'id': 5},
                    {'attime': 5, 'hopname': 'Hop 2', 'hopqty': 10, 'id': 6},
                    {'attime': 0, 'hopname': 'Hop 3', 'hopqty': 5, 'id': 7}],
           'id': 6,
           'mashsteps': [{'holdtime': 8, 'id': 16, 'orderno': 0, 'temperature': 45},
                         {'holdtime': 20, 'id': 17, 'orderno': 1, 'temperature': 64},
                         {'holdtime': 80, 'id': 18, 'orderno': 2, 'temperature': 68}],
           'name': 'Test 3',
           'starttemp': 37.5};

ctx = zmq.Context()
sock = ctx.socket(zmq.REQ)
sock.connect('tcp://127.0.0.1:42069')

def cmd(sock, cmd, data):
    zreq = {'command': cmd, 'data': data}
    pprint(["Sending", zreq])
    sock.send_json(zreq)
    zresp = sock.recv_json()
    pprint(['Reply', zresp])
    return zresp

test = 'program'

if test == 'program':
    # see whether anything is loaded
    cmd(sock, 'getProgram', None)
    # load some program
    cmd(sock, 'loadProgram', {'program': program, 'startat': 0, 'volume': 35})
    # see whether anything is loaded
    cmd(sock, 'getProgram', None)
    # get the process state 3 times, 1 sec delays
    while True:
        state = cmd(sock, 'getState', None)
        time.sleep(1)
        pass
elif test == 'buzzer':
    cmd(sock, 'buzzer', {'state': 'pulsate',
                         'cycletime': 2.3,
                         'onratio': 0.4});
    time.sleep(10);
    cmd(sock, 'buzzer', {'state': 'pulsate',
                         'cycletime': 1.3,
                         'onratio': 0.6});
    time.sleep(10);
    cmd(sock, 'buzzer', {'state': 'off'});
